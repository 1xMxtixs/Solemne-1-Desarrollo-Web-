---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <header class="bg-white shadow-sm border-b fixed top-0 inset-x-0 z-50">
    <div
      class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-center relative"
    >
      <!-- Izquierda: Volver al carrito -->
      <button
        id="back-home"
        class="flex items-center gap-2 text-[#6E0F2C] hover:text-[#8B1E3F] transition font-medium absolute left-6"
      >
        <i class="ri-arrow-left-line text-xl"></i>
        Volver al carrito
      </button>

      <!-- Centro: Logo -->
      <div class="flex items-center gap-3">
        <img src="/images/logo.svg" alt="La Nonna" class="h-10 w-auto" />
        <h1 class="text-xl font-bold text-[#6E0F2C] hidden sm:block">
          La Nonna
        </h1>
      </div>
    </div>
  </header>

  <section class="section min-h-screen bg-gray-50 py-12 mt-20">
    <div
      class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 space-y-12"
    >
      <!-- ====== DATOS DE ENTREGA ====== -->
      <div>
        <h2 class="text-3xl font-semibold text-[#6E0F2C] mb-4">
          Datos de Entrega
        </h2>
        <form id="form-entrega" class="space-y-5">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-700"
                >Nombre</label
              >
              <input
                id="nombre"
                type="text"
                class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-accent/50"
                placeholder="Nombre completo"
                required
              />
            </div>
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-700"
                >Teléfono</label
              >
              <input
                id="telefono"
                type="tel"
                class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-accent/50"
                placeholder="+56 9 1234 5678"
                required
              />
            </div>
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                id="email"
                type="email"
                class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-accent/50"
                placeholder="correo@ejemplo.com"
                required
              />
            </div>
          </div>

          <div>
            <label class="block mb-1 text-sm font-medium text-gray-700"
              >Método de Entrega</label
            >
            <select
              id="metodo-entrega"
              class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-accent/50"
            >
              <option value="delivery">Delivery</option>
              <option value="retiro">Retiro en Local</option>
            </select>
          </div>

          <!-- Campos adicionales -->
          <div id="delivery-fields" class="space-y-3">
            <label class="block mb-1 text-sm font-medium text-gray-700"
              >Dirección</label
            >
            <input
              id="direccion"
              type="text"
              class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-accent/50"
              placeholder="Dirección completa"
            />
            <p class="text-sm text-gray-600">
              Costo fijo de envío: <strong>$3.000</strong>
            </p>
          </div>

          <div id="retiro-fields" class="hidden text-sm text-gray-600">
            Retiro en Sucursal Av. Italia 1523, Providencia, Santiago – Sin
            costo adicional.
          </div>
        </form>
      </div>

      <!-- ====== PAGO ====== -->
      <div>
        <h2 class="text-3xl font-semibold text-[#6E0F2C] mb-4">Pago</h2>
        <p class="text-gray-700 text-sm mb-4">
          Verifica tus datos antes de proceder con el pago.
        </p>
        <div
          class="bg-gray-50 p-4 rounded-lg border flex items-center justify-between"
        >
          <span class="font-medium text-gray-600">Total a pagar:</span>
          <strong id="total-pagar" class="text-xl text-[#6E0F2C]">$0</strong>
        </div>
        <div class="text-right mt-6">
          <button
            id="btn-pago"
            class="bg-[#6E0F2C] hover:bg-[#8b153a] text-white px-6 py-3 rounded-lg transition font-medium"
          >
            Ir a Pago Online
          </button>
        </div>
        <p id="mensaje-pago" class="text-sm mt-3 text-gray-600"></p>
      </div>
    </div>
  </section>

  <script>
    // @ts-nocheck
    document.addEventListener("DOMContentLoaded", () => {
      const metodoEntrega = document.getElementById("metodo-entrega");
      const deliveryFields = document.getElementById("delivery-fields");
      const retiroFields = document.getElementById("retiro-fields");
      const totalPagar = document.getElementById("total-pagar");
      const btnPago = document.getElementById("btn-pago");
      const mensajePago = document.getElementById("mensaje-pago");
      const volverCarrito = document.getElementById("back-home");

      const DELIVERY_COST = 3000;

      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const montoDescuento = parseInt(
        localStorage.getItem("montoDescuento") || "0"
      );

      if (cart.length === 0) {
        window.location.href = "/Carrito";
        return;
      }

      const subtotalProductos = cart.reduce(
        (acc, item) => acc + item.price * item.qty,
        0
      );

      const actualizarTotal = () => {
        let totalFinal = subtotalProductos - montoDescuento;

        if (metodoEntrega.value === "delivery") {
          totalFinal += DELIVERY_COST;
          deliveryFields.classList.remove("hidden");
          retiroFields.classList.add("hidden");
        } else {
          deliveryFields.classList.add("hidden");
          retiroFields.classList.remove("hidden");
        }

        totalFinal = Math.max(0, totalFinal);
        totalPagar.textContent = "$" + totalFinal.toLocaleString("es-CL");

        localStorage.setItem("checkoutTotal", totalFinal);
      };

      actualizarTotal();

      metodoEntrega.addEventListener("change", actualizarTotal);
      volverCarrito.addEventListener(
        "click",
        () => (window.location.href = "/Carrito")
      );

      btnPago.addEventListener("click", async (e) => {
        e.preventDefault();
        mensajePago.textContent = "";
        mensajePago.className = "text-sm mt-3 text-gray-600";

        const nombre = document.getElementById("nombre").value.trim();
        const telefono = document.getElementById("telefono").value.trim();
        const email = document.getElementById("email").value.trim();
        const metodo = metodoEntrega.value;
        const direccion = document.getElementById("direccion").value.trim();

        if (
          !nombre ||
          !telefono ||
          !email ||
          (metodo === "delivery" && !direccion)
        ) {
          mensajePago.textContent =
            "⚠️ Por favor completa todos los campos de entrega.";
          mensajePago.classList.add("text-red-600");
          return;
        }

        const token = sessionStorage.getItem("access_token");
        if (!token) {
          alert("Tu sesión ha expirado.");
          window.location.href = "/Auth";
          return;
        }

        const itemsPayload = cart.map((i) => ({
          nombre: i.name,
          precio: i.price,
          cantidad: i.qty,
          img: i.img || "",
        }));

        const datosEntregaPayload = {
          nombre: nombre,
          email: email,
          telefono: telefono,
          metodo: metodo,
          direccion: metodo === "delivery" ? direccion : "Retiro en Local",
        };

        const totalFinal = parseInt(
          localStorage.getItem("checkoutTotal") || "0"
        );

        btnPago.disabled = true;
        btnPago.innerHTML = `<i class="ri-loader-4-line animate-spin"></i> Conectando con Webpay...`;

        try {
          const response = await fetch(
            "http://localhost:8000/api/checkout/iniciar-pago",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                items: itemsPayload,
                total: totalFinal,
                datos_entrega: datosEntregaPayload,
              }),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Error al iniciar transacción");
          }

          const data = await response.json();

          localStorage.setItem("clienteNombre", nombre);
          localStorage.setItem("clienteEmail", email);
          localStorage.setItem("metodoEntrega", metodo);
          localStorage.setItem(
            "deliveryCosto",
            metodo === "delivery" ? DELIVERY_COST : 0
          );

          const form = document.createElement("form");
          form.action = data.url;
          form.method = "POST";

          const inputToken = document.createElement("input");
          inputToken.type = "hidden";
          inputToken.name = "token_ws";
          inputToken.value = data.token;

          form.appendChild(inputToken);
          document.body.appendChild(form);
          form.submit();
        } catch (error) {
          console.error(error);
          mensajePago.textContent = "❌ Error: " + error.message;
          mensajePago.classList.add("text-red-600");
          btnPago.disabled = false;
          btnPago.textContent = "Ir a Pago Online";
        }
      });
    });
  </script>
</Layout>
