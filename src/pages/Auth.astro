---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <section class="min-h-screen flex flex-col lg:flex-row bg-gray-50">
    <!-- === Panel Izquierdo (Login / Reset / 2FA) === -->
    <div
      id="auth-left"
      class="w-full lg:w-1/2 flex items-center justify-center bg-white p-8 md:p-12 transition-all duration-500"
    >
      <div class="max-w-md w-full space-y-8">
        <!-- LOGIN -->
        <div id="login-block">
          <h2 class="text-3xl font-bold text-[#6E0F2C]">Bienvenido de nuevo</h2>
          <p class="text-gray-500 text-sm mb-6">
            Ingresa tus credenciales para acceder
          </p>

          <form id="login-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-[#6E0F2C]"
                >Email</label
              >
              <input
                type="email"
                id="email"
                class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-[#6E0F2C]/40"
                placeholder="usuario@demo.com"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-[#6E0F2C]"
                >Contrase√±a</label
              >
              <input
                type="password"
                id="password"
                class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-[#6E0F2C]/40"
                placeholder="********"
                required
              />
            </div>

            <button
              type="submit"
              class="w-full bg-[#6E0F2C] hover:bg-[#8B1E3F] text-white font-medium rounded-lg p-3 transition"
            >
              Iniciar Sesi√≥n
            </button>
          </form>

          <div
            class="flex flex-col sm:flex-row justify-between items-center text-sm mt-5 gap-y-3"
          >
            <a href="#" id="show-reset" class="text-[#6E0F2C] hover:underline"
              >Olvid√© mi contrase√±a</a
            >
            <a href="#" id="show-2fa" class="text-[#6E0F2C] hover:underline"
              >Configurar 2FA</a
            >
            <a
              href="#"
              id="show-registro"
              class="text-[#6E0F2C] font-medium hover:underline">Registrarme</a
            >
          </div>
        </div>

        <!-- RESET -->
        <div id="reset-block" class="hidden transition-all duration-300">
          <h2 class="text-2xl font-bold text-[#6E0F2C]">
            Restablecer Contrase√±a
          </h2>
          <p class="text-gray-500 text-sm mb-6">
            Ingresa tu correo para enviarte un enlace de recuperaci√≥n
          </p>
          <form class="space-y-4" id="reset-form">
            <input
              type="email"
              class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-[#6E0F2C]/40"
              placeholder="correo@ejemplo.com"
              required
            />
            <button
              class="w-full bg-[#6E0F2C] hover:bg-[#8B1E3F] text-white rounded-lg p-3 transition"
            >
              Enviar enlace
            </button>
          </form>
          <a
            href="#"
            id="back-login"
            class="block text-sm text-[#6E0F2C] mt-4 hover:underline"
            >‚Üê Volver al login</a
          >
        </div>

        <!-- 2FA -->
        <div id="twofa-block" class="hidden transition-all duration-300">
          <h2 class="text-2xl font-bold text-[#6E0F2C]">Configurar 2FA</h2>
          <p class="text-gray-500 text-sm mb-6">
            Ingresa tu tel√©fono para recibir un c√≥digo SMS.
          </p>

          <form class="space-y-4" id="form-2fa">
            <div class="flex gap-2">
              <input
                type="tel"
                id="2fa-phone"
                class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-[#6E0F2C]/40"
                placeholder="+56 9 1234 5678"
                required
              />
              <button
                type="button"
                id="btn-send-code"
                class="bg-gray-800 text-white px-4 rounded-lg text-sm hover:bg-gray-900 whitespace-nowrap"
              >
                Enviar C√≥digo
              </button>
            </div>

            <div id="code-container" class="hidden space-y-4">
              <input
                type="text"
                id="2fa-code"
                class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-[#6E0F2C]/40 text-center tracking-widest font-bold text-xl"
                placeholder="0 0 0 0"
                maxlength="4"
              />

              <button
                type="submit"
                class="w-full bg-[#6E0F2C] hover:bg-[#8B1E3F] text-white rounded-lg p-3 transition"
              >
                Confirmar y Activar
              </button>
            </div>
          </form>

          <a
            href="#"
            id="back-login-2fa"
            class="block text-sm text-[#6E0F2C] mt-4 hover:underline"
            >‚Üê Volver al login</a
          >
        </div>
      </div>
    </div>

    <!-- === Panel Derecho Imagen === -->
    <div
      id="login-image"
      class="hidden lg:flex w-1/2 bg-[#6E0F2C]/5 items-center justify-center"
    >
      <img
        src="/images/Login/1.jpeg "
        alt="Imagen restaurante"
        class="w-full h-full object-cover rounded-l-2xl"
      />
    </div>

    <!-- === PANEL REGISTRO === -->
    <div
      id="registro-block"
      class="fixed inset-0 bg-white flex flex-col lg:flex-row items-center justify-center opacity-0 pointer-events-none z-50
         transition-all duration-500 ease-in-out translate-y-4"
    >
      <div class="max-w-md w-full p-8 md:p-10 space-y-6">
        <h2 class="text-3xl font-bold text-[#6E0F2C]">Crear Cuenta</h2>
        <p class="text-gray-500 text-sm mb-4">
          Ingresa tus datos para registrarte
        </p>
        <form class="space-y-4" id="registro-form">
          <input
            type="text"
            class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-[#6E0F2C]/40"
            placeholder="Nombre completo"
            required
          />
          <input
            type="email"
            class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-[#6E0F2C]/40"
            placeholder="correo@ejemplo.com"
            required
          />
          <input
            type="password"
            class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-[#6E0F2C]/40"
            placeholder="Contrase√±a"
            required
          />
          <button
            class="w-full bg-[#6E0F2C] hover:bg-[#8B1E3F] text-white rounded-lg p-3 transition"
          >
            Crear Cuenta
          </button>
        </form>
        <a
          href="#"
          id="back-login-reg"
          class="block text-sm text-[#6E0F2C] hover:underline"
          >‚Üê Volver al login</a
        >
      </div>
    </div>
  </section>

  <script>
    // @ts-nocheck
    document.addEventListener("DOMContentLoaded", () => {
      // --- Selectores de PANELES ---
      const loginBlock = document.getElementById("login-block");
      const resetBlock = document.getElementById("reset-block");
      const twofaBlock = document.getElementById("twofa-block");
      const registroBlock = document.getElementById("registro-block");

      // --- Selectores de FORMULARIOS ---
      const loginForm = document.getElementById("login-form");
      const registroForm = document.getElementById("registro-form");
      const resetForm = document.getElementById("reset-form");

      // --- Selectores 2FA ---
      const form2FA = document.getElementById("form-2fa");
      const btnSendCode = document.getElementById("btn-send-code");
      const codeContainer = document.getElementById("code-container");
      const phoneInput = document.getElementById("2fa-phone");
      const codeInput = document.getElementById("2fa-code");

      // --- Funciones de Navegaci√≥n ---
      function irAlLogin() {
        registroBlock.classList.add("opacity-0", "translate-y-4");
        registroBlock.classList.remove("pointer-events-auto");
        setTimeout(() => {
          registroBlock.classList.add("hidden", "pointer-events-none");
          loginBlock.classList.remove("hidden");
        }, 500);
      }

      // Mostrar Reset
      document.getElementById("show-reset")?.addEventListener("click", (e) => {
        e.preventDefault();
        loginBlock.classList.add("hidden");
        resetBlock.classList.remove("hidden");
      });

      // Volver de Reset
      document.getElementById("back-login")?.addEventListener("click", (e) => {
        e.preventDefault();
        resetBlock.classList.add("hidden");
        loginBlock.classList.remove("hidden");
      });

      // Mostrar 2FA
      document.getElementById("show-2fa")?.addEventListener("click", (e) => {
        e.preventDefault();
        loginBlock.classList.add("hidden");
        twofaBlock.classList.remove("hidden");
      });

      // Volver de 2FA
      document
        .getElementById("back-login-2fa")
        ?.addEventListener("click", (e) => {
          e.preventDefault();
          twofaBlock.classList.add("hidden");
          loginBlock.classList.remove("hidden");
        });

      // Mostrar Registro
      document
        .getElementById("show-registro")
        ?.addEventListener("click", (e) => {
          e.preventDefault();
          loginBlock.classList.add("hidden");
          registroBlock.classList.remove("hidden", "pointer-events-none");
          registroBlock.classList.add("pointer-events-auto");
          registroBlock.classList.add("opacity-0", "translate-y-4");
          void registroBlock.offsetWidth;
          registroBlock.classList.remove("opacity-0", "translate-y-4");
        });

      // Volver de Registro
      document
        .getElementById("back-login-reg")
        ?.addEventListener("click", (e) => {
          e.preventDefault();
          irAlLogin();
        });

      // ==========================================
      // 1. L√ìGICA DE LOGIN
      // ==========================================
      loginForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const formData = new URLSearchParams();
        formData.append("username", email);
        formData.append("password", password);

        try {
          const response = await fetch("http://localhost:8000/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData,
          });

          if (response.ok) {
            const data = await response.json();
            sessionStorage.setItem("access_token", data.access_token);
            sessionStorage.setItem("usuario", JSON.stringify(data.usuario));

            const rol = data.usuario.rol;
            if (rol === "administrador") window.location.href = "/PanelAdmin";
            else if (rol === "cliente") window.location.href = "/";
            else if (rol === "logistica")
              window.location.href = "/PanelDespacho";
            else if (rol === "due√±o") window.location.href = "/PanelBoss";
            else window.location.href = "/";
          } else {
            alert("‚ö†Ô∏è Credenciales incorrectas.");
          }
        } catch (error) {
          console.error(error);
          alert("Error de conexi√≥n con el servidor.");
        }
      });

      // ==========================================
      // 2. L√ìGICA DE REGISTRO
      // ==========================================
      registroForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const inputs = registroForm.querySelectorAll("input");
        const nombre = inputs[0].value;
        const email = inputs[1].value;
        const contrasena = inputs[2].value;

        try {
          const response = await fetch(
            "http://localhost:8000/api/auth/registro",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ nombre, email, contrasena }),
            }
          );

          if (response.status === 201) {
            alert("¬°Cuenta creada! Inicia sesi√≥n.");
            registroForm.reset();
            irAlLogin();
          } else {
            const errorData = await response.json();
            alert("‚ö†Ô∏è " + (errorData.detail || "Error al registrarse"));
          }
        } catch (error) {
          console.error(error);
          alert("Error de conexi√≥n.");
        }
      });

      // ==========================================
      // 3. L√ìGICA DE RESET PASSWORD
      // ==========================================
      resetForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const emailInput = resetForm.querySelector("input[type='email']");
        const email = emailInput.value.trim();
        const btn = document.getElementById("btn-reset-submit");

        if (btn) {
          btn.disabled = true;
          btn.innerText = "Enviando...";
        }

        try {
          await fetch("http://localhost:8000/api/auth/password-recovery", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          alert("‚úÖ Si el correo existe, se ha enviado un enlace.");
          document.getElementById("back-login").click();
        } catch (error) {
          console.error(error);
          alert("Error de conexi√≥n.");
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerText = "Enviar enlace";
          }
        }
      });

      // ==========================================
      // 4. L√ìGICA DE 2FA 
      // ==========================================

      btnSendCode?.addEventListener("click", async () => {
        const telefono = phoneInput.value.trim();
        if (!telefono) {
          alert("Ingresa un n√∫mero de tel√©fono");
          return;
        }

        btnSendCode.disabled = true;
        btnSendCode.innerText = "Enviando...";

        try {
          await fetch("http://localhost:8000/api/auth/2fa/request", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ telefono }),
          });

          alert("üì® C√≥digo enviado (Revisa la consola del Backend)");

          codeContainer.classList.remove("hidden");
          phoneInput.readOnly = true;
        } catch (e) {
          console.error(e);
          alert("Error de conexi√≥n al enviar c√≥digo");
        } finally {
          btnSendCode.disabled = false;
          btnSendCode.innerText = "Reenviar";
        }
      });

      form2FA?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const telefono = phoneInput.value.trim();
        const codigo = codeInput.value.trim();

        try {
          const res = await fetch("http://localhost:8000/api/auth/2fa/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ telefono, codigo }),
          });

          if (res.ok) {
            alert("‚úÖ ¬°Seguridad activada! 2FA configurado correctamente.");
            twofaBlock.classList.add("hidden");
            loginBlock.classList.remove("hidden");
          } else {
            const err = await res.json();
            alert("‚ùå " + (err.detail || "C√≥digo incorrecto"));
          }
        } catch (e) {
          console.error(e);
          alert("Error al verificar");
        }
      });
    });
  </script>
</Layout>
