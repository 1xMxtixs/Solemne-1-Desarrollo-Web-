---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Home/Header.astro";

interface Categoria {
  slug: string;
  nombre: string;
}

interface Imagen {
  url: string;
}

interface Producto {
  nombre: string;
  descripcion: string;
  precio_base: number;
  categoria: Categoria;
  imagenes: Imagen[];
}

let categorias: Categoria[] = [];
let productos: Producto[] = [];
let errorCarga: string | null = null;

try {
  const [catResponse, prodResponse] = await Promise.all([
    fetch("http://localhost:8000/api/categorias"),
    fetch("http://localhost:8000/api/productos?solo_activos=true"),
  ]);

  if (catResponse.ok) categorias = await catResponse.json();
  if (prodResponse.ok) productos = await prodResponse.json();
} catch (error) {
  console.error("Error conectando con API:", error);
  errorCarga = "No se pudo cargar el men√∫. Por favor intenta m√°s tarde.";
}

const formatoCLP = (valor: number) => {
  return new Intl.NumberFormat("es-CL", {
    style: "currency",
    currency: "CLP",
  }).format(valor);
};
---

<Layout>
  <Header />

  <section class="bg-gray-50 pt-24 py-12">
    <div class="max-w-7xl mx-auto px-6 space-y-10">
      <header class="text-center">
        <h2 class="text-3xl font-bold text-primary">üçù Nuestro Men√∫</h2>
        <p class="text-gray-500 mt-2">
          Descubre la mejor selecci√≥n de comida italiana
        </p>
        {errorCarga && <p class="text-red-500 mt-4 font-bold">{errorCarga}</p>}
      </header>

      <div class="flex flex-wrap justify-center gap-4">
        <button
          class="category-btn px-5 py-2 rounded-full bg-accent text-white font-semibold transition hover:bg-accent hover:text-white"
          data-category="todos">Todos</button
        >

        {
          categorias.map((cat) => (
            <button
              class="category-btn px-5 py-2 rounded-full bg-gray-200 text-gray-700 font-semibold transition hover:bg-accent hover:text-white"
              data-category={cat.slug}
            >
              {cat.nombre}
            </button>
          ))
        }
      </div>

      <div
        id="menu-list"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        {
          productos.map((prod) => {
            const imagenUrl =
              prod.imagenes && prod.imagenes.length > 0
                ? `http://localhost:8000${prod.imagenes[0].url}`
                : "/images/placeholder-food.jpg"; 

            return (
              <div
                data-category={prod.categoria.slug}
                class="bg-white rounded-xl shadow hover:shadow-lg transition group cursor-pointer open-modal product-card"
                data-json={JSON.stringify({
                  title: prod.nombre,
                  desc: prod.descripcion || "Sin descripci√≥n",
                  price: prod.precio_base,
                  img: imagenUrl,
                })}
              >
                <div class="overflow-hidden rounded-t-xl relative h-48">
                  <img
                    src={imagenUrl}
                    alt={prod.nombre}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                    onerror="this.src='/images/logo.svg'"
                  />
                </div>
                <div class="p-4">
                  <h3 class="text-lg font-bold text-primary">{prod.nombre}</h3>
                  <p class="text-sm text-gray-500 line-clamp-2">
                    {prod.descripcion || "Deliciosa preparaci√≥n de la casa."}
                  </p>
                  <p class="text-accent font-semibold mt-2">
                    {formatoCLP(prod.precio_base)}
                  </p>
                </div>
              </div>
            );
          })
        }
      </div>
    </div>
  </section>

  <div
    id="plato-modal"
    class="fixed inset-0 hidden items-center justify-center z-50 bg-black/40 backdrop-blur-sm"
  >
    <div
      class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 relative mx-4"
    >
      <button
        id="close-modal"
        class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl"
        ><i class="ri-close-line text-3xl"></i></button
      >
      <div id="modal-content"></div>
      <button
        id="add-to-cart-btn"
        class="mt-4 w-full py-2 bg-accent text-white rounded-lg hover:bg-accent-secondary transition"
      >
        ‚ûï A√±adir al Carrito
      </button>
    </div>
  </div>

  <script>
    // @ts-nocheck
    document.addEventListener("DOMContentLoaded", () => {
      const categoryBtns = document.querySelectorAll(".category-btn");
      const cards = document.querySelectorAll(".product-card");
      const modal = document.getElementById("plato-modal");
      const closeModal = document.getElementById("close-modal");
      const modalContent = document.getElementById("modal-content");
      const addToCartBtn = document.getElementById("add-to-cart-btn");

      let currentPlato = null;

      // === Estilos de categor√≠as ===
      const updateCategoryStyles = (selectedBtn) => {
        categoryBtns.forEach((b) => {
          b.classList.remove("bg-accent", "text-white");
          b.classList.add("bg-gray-200", "text-gray-700");
        });

        if (selectedBtn) {
          selectedBtn.classList.add("bg-accent", "text-white");
          selectedBtn.classList.remove("bg-gray-200", "text-gray-700");
        }
      };

      // === Agregar al carrito ===
      addToCartBtn?.addEventListener("click", () => {
        if (!currentPlato) return;

        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        const { title, desc, price, img } = currentPlato;
        const existing = cart.find((item) => item.name === title);

        if (existing) {
          existing.qty += 1;
        } else {
          cart.push({ name: title, desc, price, img, qty: 1 });
        }

        localStorage.setItem("cart", JSON.stringify(cart));

        window.dispatchEvent(new Event("cart-updated"));

        const originalText = addToCartBtn.innerText;
        addToCartBtn.innerText = "‚úî Agregado!";
        setTimeout(() => {
          addToCartBtn.innerText = "‚ûï A√±adir al Carrito";
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }, 1000);
      });

      // === Filtro por categor√≠a ===
      categoryBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          updateCategoryStyles(btn);
          const category = btn.dataset.category;

          cards.forEach((card) => {
            if (category === "todos") {
              card.style.display = "block";
            } else {
              card.style.display =
                card.dataset.category === category ? "block" : "none";
            }
          });
        });
      });

      // === Abrir modal de plato ===
      cards.forEach((card) => {
        card.addEventListener("click", () => {
          const data = JSON.parse(card.dataset.json);

          currentPlato = data;

          modalContent.innerHTML = `
          <img src="${data.img}" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.src='/images/logo.svg'"/>
          <h3 class="text-xl font-bold text-primary">${data.title}</h3>
          <p class="text-gray-500">${data.desc}</p>
          <p class="text-accent font-semibold mt-2">$${data.price.toLocaleString("es-CL")}</p>
        `;
          addToCartBtn.innerText = "‚ûï A√±adir al Carrito";
          modal.classList.remove("hidden");
          modal.classList.add("flex");
        });
      });

      // === Cerrar modal ===
      closeModal.addEventListener("click", () => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        currentPlato = null;
      });

      // Cerrar modal con click afuera
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
      });
    });
  </script>
</Layout>
