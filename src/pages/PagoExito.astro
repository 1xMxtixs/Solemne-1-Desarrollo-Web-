---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Confirmando Pago...">
  <section class="min-h-screen flex items-center justify-center bg-gray-50">
    <div class="bg-white p-8 rounded-xl shadow-xl text-center max-w-md w-full">
      <div id="estado-cargando">
        <div
          class="animate-spin rounded-full h-16 w-16 border-b-4 border-accent mx-auto mb-4"
        >
        </div>
        <h2 class="text-2xl font-bold text-gray-800">Verificando Pago...</h2>
        <p class="text-gray-500 mt-2">
          Estamos confirmando la transacción con Transbank.
        </p>
      </div>

      <div id="estado-exito" class="hidden animate-fade-in">
        <div
          class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"
        >
          <i class="ri-check-line"></i>
        </div>
        <h2 class="text-2xl font-bold text-green-700">¡Pago Exitoso!</h2>
        <p class="text-gray-600 mt-2">
          Tu orden <span id="num-orden" class="font-bold text-gray-800"></span> ha
          sido aprobada.
        </p>

        <div class="mt-8 space-y-3">
          <button
            id="btn-ver-boleta"
            class="block w-full py-3 bg-[#6E0F2C] text-white rounded-lg hover:bg-[#8b153a] transition shadow font-medium"
          >
            Ver Boleta
          </button>
          <a
            href="/Menu"
            class="block w-full py-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 transition"
          >
            Volver al Menú
          </a>
        </div>
      </div>

      <div id="estado-error" class="hidden animate-fade-in">
        <div
          class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"
        >
          <i class="ri-close-line"></i>
        </div>
        <h2 class="text-2xl font-bold text-red-700">Pago No Completado</h2>
        <p class="text-gray-600 mt-2" id="msg-error">
          La transacción fue anulada por el usuario o rechazada por el banco.
        </p>
        <a
          href="/Pagos"
          class="block w-full mt-6 py-3 bg-accent text-white rounded-lg hover:bg-accent-secondary transition shadow"
          >Intentar Nuevamente</a
        >
      </div>
    </div>
  </section>

  <script>
    // @ts-nocheck
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const tokenWs = params.get("token_ws");
      const tbkToken = params.get("TBK_TOKEN"); 

      const divCargando = document.getElementById("estado-cargando");
      const divExito = document.getElementById("estado-exito");
      const divError = document.getElementById("estado-error");

      if (tbkToken && !tokenWs) {
        divCargando.classList.add("hidden");
        divError.classList.remove("hidden");
        return;
      }

      if (tokenWs) {
        try {
          const response = await fetch(
            "http://localhost:8000/api/checkout/confirmar-pago",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token_ws: tokenWs }),
            }
          );

          if (response.ok) {
            const orden = await response.json();

            localStorage.removeItem("cart");
            localStorage.removeItem("checkoutTotal");

            localStorage.setItem("ordenID", orden.numeroOrden);
            localStorage.setItem("ordenTotal", orden.total);
            localStorage.setItem(
              "ordenConfirmada",
              JSON.stringify(orden.items)
            );

            document.getElementById("num-orden").textContent =
              "#" + orden.numeroOrden;

            document
              .getElementById("btn-ver-boleta")
              .addEventListener("click", () => {
                window.location.href = "/Boleta";
              });

            divCargando.classList.add("hidden");
            divExito.classList.remove("hidden");
          } else {
            throw new Error("Pago rechazado por backend");
          }
        } catch (error) {
          console.error(error);
          divCargando.classList.add("hidden");
          divError.classList.remove("hidden");
        }
      } else {
        window.location.href = "/";
      }
    });
  </script>
</Layout>
