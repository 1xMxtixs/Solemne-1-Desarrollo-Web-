---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Home/Header.astro";
---

<Layout>
  <Header />

  <section class="bg-gray-50 pt-24 pb-12">
    <div class="max-w-7xl mx-auto px-6 space-y-8">
      <!-- Título -->
      <header class="text-center">
        <h2 class="text-3xl font-bold text-primary">🛒 Carrito de Compras</h2>
        <p class="text-gray-500 mt-2">
          Revisa los productos antes de finalizar tu pedido
        </p>
      </header>

      <!-- Contenido -->
      <div id="carrito-container" class="space-y-6">
        <!-- Aquí se insertan los productos dinámicamente -->
      </div>

      <!-- Sección de Descuento -->
      <div
        class="bg-white rounded-xl shadow p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
      >
        <div
          class="w-full sm:w-auto flex flex-col sm:flex-row items-center gap-3"
        >
          <label for="cupon" class="text-sm font-medium text-primary"
            >¿Tienes un cupón de descuento?</label
          >
          <input
            id="cupon"
            type="text"
            placeholder="Ingresa tu código"
            class="border rounded-lg p-2 w-full sm:w-60 focus:ring-2 focus:ring-accent/50"
          />
        </div>
        <button
          id="btn-aplicar-cupon"
          class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-accent-secondary transition"
        >
          Aplicar Cupón
        </button>
      </div>

      <!-- Resumen -->
      <div
        class="bg-white rounded-xl shadow-lg p-6 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4"
      >
        <p class="text-lg font-bold text-primary">
          Total: <span id="carrito-total">$0</span>
        </p>
        <button
          id="go-to-checkout"
          class="px-6 py-3 bg-accent text-white rounded-lg hover:bg-accent-secondary transition shadow"
        >
          Proceder al Pago
        </button>
      </div>
    </div>
  </section>

  <script>
    // @ts-nocheck
    document.addEventListener("DOMContentLoaded", () => {
      const carritoContainer = document.getElementById("carrito-container");
      const carritoTotal = document.getElementById("carrito-total");

      // Recuperar carrito desde localStorage
      let cart = JSON.parse(localStorage.getItem("cart")) || [];

      function renderCarrito() {
        carritoContainer.innerHTML = "";

        if (cart.length === 0) {
          carritoContainer.innerHTML = `
          <p class="text-gray-500 text-center">Tu carrito está vacío</p>
        `;
          carritoTotal.textContent = "$0";
          return;
        }

        cart.forEach((item, index) => {
          carritoContainer.innerHTML += `
          <div class="bg-white rounded-lg shadow p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex items-center gap-4">
              <img src="${item.img}" class="w-20 h-20 object-cover rounded" />
              <div>
                <h3 class="text-lg font-bold text-primary">${item.name}</h3>
                <p class="text-sm text-gray-500">$${item.price.toLocaleString()}</p>
              </div>
            </div>

            <div class="flex items-center gap-4">
              <button onclick="updateQty(${index}, -1)" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">-</button>
              <span>${item.qty}</span>
              <button onclick="updateQty(${index}, 1)" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">+</button>
            </div>

            <p class="font-semibold text-accent">$${(item.price * item.qty).toLocaleString()}</p>

            <button onclick="removeFromCarrito(${index})" class="text-red-500 hover:text-red-700">
              <i class="ri-delete-bin-line text-xl"></i>
            </button>
          </div>
        `;
        });

        carritoTotal.textContent =
          "$" +
          cart
            .reduce((acc, item) => acc + item.price * item.qty, 0)
            .toLocaleString();
      }

      // Actualizar cantidad
      window.updateQty = (index, change) => {
        cart[index].qty += change;
        if (cart[index].qty <= 0) cart.splice(index, 1);
        saveCarrito();
      };

      // Eliminar producto
      window.removeFromCarrito = (index) => {
        cart.splice(index, 1);
        saveCarrito();
      };

      function saveCarrito() {
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCarrito();
      }

      renderCarrito();
    });

    document.addEventListener("DOMContentLoaded", () => {
      const goToCheckoutBtn = document.getElementById("go-to-checkout");
      if (goToCheckoutBtn) {
        goToCheckoutBtn.addEventListener("click", () => {
          const cart = JSON.parse(localStorage.getItem("cart") || "[]");
          if (cart.length === 0) {
            alert(
              "Tu carrito está vacío. Agrega productos antes de proceder al pago."
            );
            return;
          }
          window.location.href = "/Checkout";
        });
      }
    });
  </script>
</Layout>
