---

let usuarios = [];
try {
  const res = await fetch("http://localhost:8000/api/admin/users");
  if (res.ok) usuarios = await res.json();
} catch (e) {
  console.error(e);
}
---

<div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 space-y-6">
  <div class="flex justify-between items-center">
    <h2 class="text-xl font-bold text-primary">Gestión de Usuarios</h2>
    <span
      class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold"
      >{usuarios.length} Registrados</span
    >
  </div>

  <div class="overflow-x-auto">
    <table
      class="min-w-full text-sm rounded-lg overflow-hidden shadow border border-gray-100"
    >
      <thead class="bg-primary text-white">
        <tr>
          <th class="px-4 py-3 text-left">Nombre</th>
          <th class="px-4 py-3 text-left">Email</th>
          <th class="px-4 py-3 text-left">Rol Actual</th>
          <th class="px-4 py-3 text-center">Acciones</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {
          usuarios.map((u: any) => (
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 font-medium">{u.nombre}</td>
              <td class="px-4 py-3 text-gray-500">{u.email}</td>
              <td class="px-4 py-3">
                <span
                  class={`px-2 py-1 text-xs rounded-full font-bold
                            ${
                              u.rol === "administrador"
                                ? "bg-purple-100 text-purple-700"
                                : u.rol === "dueño"
                                  ? "bg-orange-100 text-orange-700"
                                  : u.rol === "logistica"
                                    ? "bg-blue-100 text-blue-700"
                                    : "bg-gray-100 text-gray-600"
                            }`}
                >
                  {u.rol}
                </span>
              </td>
              <td class="px-4 py-3 text-center space-x-2">
                <button
                  class="text-blue-600 hover:text-blue-800 btn-editar-user"
                  data-json={JSON.stringify(u)}
                >
                  <i class="ri-edit-box-line text-lg" />
                </button>
                <button
                  class="text-red-500 hover:text-red-700 btn-eliminar-user"
                  data-id={u.id || u._id}
                >
                  <i class="ri-delete-bin-line text-lg" />
                </button>
              </td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </div>
</div>

<div
  id="modal-user"
  class="fixed inset-0 z-50 hidden bg-black/40 backdrop-blur-sm items-center justify-center"
>
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h3 class="text-lg font-bold mb-4">Editar Usuario</h3>
    <form id="form-user" class="space-y-4">
      <input type="hidden" id="user-id" />
      <div>
        <label class="block text-sm text-gray-600">Nombre</label>
        <input
          type="text"
          id="user-nombre"
          class="input w-full border p-2 rounded"
          readonly
        />
      </div>
      <div>
        <label class="block text-sm text-gray-600">Rol</label>
        <select id="user-rol" class="input w-full border p-2 rounded bg-white">
          <option value="cliente">Cliente</option>
          <option value="administrador">Administrador</option>
          <option value="logistica">Logística / Bodega</option>
          <option value="dueño">Dueño</option>
        </select>
      </div>
      <div class="flex justify-end gap-3 pt-2">
        <button
          type="button"
          id="btn-close-user"
          class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          >Cancelar</button
        >
        <button
          type="submit"
          class="px-4 py-2 bg-accent text-white rounded hover:bg-accent-secondary"
          >Guardar Cambios</button
        >
      </div>
    </form>
  </div>
</div>

<script>
  // @ts-nocheck
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("modal-user");
    const form = document.getElementById("form-user");
    const btnClose = document.getElementById("btn-close-user");

    const inpId = document.getElementById("user-id");
    const inpNombre = document.getElementById("user-nombre");
    const inpRol = document.getElementById("user-rol");

    // Editar
    document.querySelectorAll(".btn-editar-user").forEach((btn) => {
      btn.addEventListener("click", () => {
        const data = JSON.parse(btn.dataset.json);
        inpId.value = data.id || data._id;
        inpNombre.value = data.nombre;
        inpRol.value = data.rol;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      });
    });

    btnClose.addEventListener("click", () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });

    // Guardar
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = inpId.value;
      const nuevoRol = inpRol.value;

      try {
        const res = await fetch(`http://localhost:8000/api/admin/users/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ rol: nuevoRol }),
        });
        if (res.ok) {
          alert("✅ Rol actualizado");
          window.location.reload();
        }
      } catch (e) {
        console.error(e);
      }
    });

    // Eliminar
    document.querySelectorAll(".btn-eliminar-user").forEach((btn) => {
      btn.addEventListener("click", async () => {
        if (!confirm("¿Eliminar este usuario permanentemente?")) return;
        try {
          await fetch(
            `http://localhost:8000/api/admin/users/${btn.dataset.id}`,
            { method: "DELETE" }
          );
          window.location.reload();
        } catch (e) {
          alert("Error");
        }
      });
    });
  });
</script>
