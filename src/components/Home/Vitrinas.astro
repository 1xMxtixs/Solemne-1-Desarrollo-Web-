---
// src/components/Home/Vitrinas.astro

// 1. FETCH DE VITRINAS
let vitrinas = [];
try {
  const res = await fetch("http://localhost:8000/api/vitrinas");
  if (res.ok) {
    const data = await res.json();
    // Filtramos solo las vitrinas activas y con productos
    vitrinas = data.filter((v: any) => v.activa && v.productos.length > 0);
  }
} catch (e) {
  console.error("Error cargando vitrinas:", e);
}

const formatoCLP = (valor: number) =>
  new Intl.NumberFormat("es-CL", { style: "currency", currency: "CLP" }).format(
    valor
  );
---

{
  vitrinas.map((vitrina: any) => (
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-6">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-primary flex items-center justify-center gap-3">
            <i class="ri-fire-line text-accent" /> {vitrina.nombre}
          </h2>
          <div class="h-1 w-24 bg-accent mx-auto mt-4 rounded-full" />
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
          {vitrina.productos.map((prod: any) => {
            // 1. REGLA: Si es Borrador, lo ocultamos totalmente
            if (prod.estado === "Borrador") return null;

            // 2. REGLA: Verificamos si est치 activo para la venta
            const disponible = prod.estado === "Activo";

            const imagenUrl =
              prod.imagenes && prod.imagenes.length > 0
                ? `http://localhost:8000${prod.imagenes[0].url}`
                : "/images/logo.svg";

            return (
              <div
                class={`group bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden transition-all duration-300 transform hover:-translate-y-1 ${!disponible ? "opacity-80 grayscale" : "hover:shadow-xl"}`}
              >
                <div class="relative h-48 overflow-hidden">
                  <img
                    src={imagenUrl}
                    alt={prod.nombre}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                    onerror="this.src='/images/logo.svg'"
                  />

                  {disponible && (
                    <button
                      class="btn-add-cart absolute bottom-3 right-3 bg-white text-accent p-3 rounded-full shadow-md hover:bg-accent hover:text-white transition z-10"
                      data-json={JSON.stringify({
                        title: prod.nombre,
                        price: prod.precio_base,
                        img: imagenUrl,
                        id: prod.id,
                      })}
                      title="Agregar al Carrito"
                    >
                      <i class="ri-shopping-cart-2-fill text-lg" />
                    </button>
                  )}

                  {!disponible && (
                    <div class="absolute inset-0 bg-gray-900/10 flex items-center justify-center">
                      <span class="bg-gray-800 text-white px-3 py-1 rounded-full text-xs font-bold shadow">
                        No Disponible
                      </span>
                    </div>
                  )}
                </div>

                <div class="p-5">
                  <div class="flex justify-between items-start mb-2">
                    <h3
                      class={`font-bold text-lg line-clamp-1 ${disponible ? "text-gray-800" : "text-gray-500"}`}
                    >
                      {prod.nombre}
                    </h3>
                  </div>
                  <p class="text-sm text-gray-500 mb-4 line-clamp-2 h-10">
                    {prod.descripcion || "Deliciosa preparaci칩n de la casa."}
                  </p>

                  <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                    <span
                      class={`font-bold text-xl ${disponible ? "text-primary" : "text-gray-400 line-through"}`}
                    >
                      {formatoCLP(prod.precio_base)}
                    </span>

                    {/* Etiqueta de Estado */}
                    {disponible ? (
                      <span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-full border border-green-100">
                        Disponible
                      </span>
                    ) : (
                      <span class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded-full border border-red-100">
                        Agotado
                      </span>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </section>
  ))
}

<script>
  // @ts-nocheck
  document.addEventListener("DOMContentLoaded", () => {
    // L칩gica para agregar al carrito (Solo funcionar치 en los botones que existen)
    document.querySelectorAll(".btn-add-cart").forEach((btn) => {
      btn.addEventListener("click", () => {
        const data = JSON.parse(btn.dataset.json);

        let cart = JSON.parse(localStorage.getItem("cart") || "[]");

        const existing = cart.find((item) => item.name === data.title);

        if (existing) {
          existing.qty += 1;
        } else {
          cart.push({
            name: data.title,
            desc: "",
            price: data.price,
            img: data.img,
            qty: 1,
            id: data.id,
          });
        }

        localStorage.setItem("cart", JSON.stringify(cart));
        window.dispatchEvent(new Event("cart-updated"));

        // Feedback Visual
        const originalHTML = btn.innerHTML;
        btn.innerHTML = `<i class="ri-check-line"></i>`;
        btn.classList.add("bg-green-500", "text-white");

        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.classList.remove("bg-green-500", "text-white");
        }, 1000);
      });
    });
  });
</script>
