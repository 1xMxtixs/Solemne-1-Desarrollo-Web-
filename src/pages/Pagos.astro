---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <section
    class="min-h-screen bg-gray-50 flex items-center justify-center py-16 px-4"
  >
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-2xl p-8 space-y-8">
      <header class="text-center">
        <h1 class="text-3xl font-bold text-[#6E0F2C] mb-2">Pago Online</h1>
        <p id="order-info" class="text-gray-600 text-sm">Cargando total...</p>
      </header>

      <div
        class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800"
      >
        <p class="font-semibold">
          <i class="ri-secure-payment-line"></i> Pago Seguro
        </p>
        <p>
          Serás redirigido al sitio seguro de <strong>Webpay Plus</strong> para completar
          tu transacción.
        </p>
      </div>

      <button
        id="btn-pagar"
        class="w-full bg-[#6E0F2C] hover:bg-[#8b153a] text-white py-4 rounded-lg font-bold text-lg transition flex items-center justify-center gap-2 shadow-lg"
      >
        <span>Ir a Pagar con Webpay</span>
        <i class="ri-arrow-right-line"></i>
      </button>

      <div class="text-center">
        <a href="/Checkout" class="text-sm text-gray-500 hover:underline"
          >Volver a datos de entrega</a
        >
      </div>
    </div>
  </section>

  <script>
    // @ts-nocheck
    document.addEventListener("DOMContentLoaded", () => {
      const btnPagar = document.getElementById("btn-pagar");

      // 1. Mostrar info inicial
      const total = localStorage.getItem("checkoutTotal") || "0";
      document.getElementById("order-info").textContent =
        `Total a pagar: $${parseInt(total).toLocaleString("es-CL")}`;

      btnPagar?.addEventListener("click", async () => {
        const token = sessionStorage.getItem("access_token");

        if (!token) {
          alert("Tu sesión ha expirado. Por favor inicia sesión.");
          window.location.href = "/Auth";
          return;
        }

        const cart = JSON.parse(localStorage.getItem("cart") || "[]");
        if (cart.length === 0) {
          alert("El carrito está vacío");
          window.location.href = "/Menu";
          return;
        }

        const itemsPayload = cart.map((i) => ({
          nombre: i.name,
          precio: i.price,
          cantidad: i.qty,
          img: i.img || "",
        }));

        btnPagar.disabled = true;
        btnPagar.innerHTML = `<i class="ri-loader-4-line animate-spin"></i> Conectando con el Banco...`;

        try {
          const response = await fetch(
            "http://localhost:8000/api/checkout/iniciar-pago",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                items: itemsPayload,
                total: parseFloat(total),
              }),
            }
          );

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || "Error al iniciar pago");
          }

          const data = await response.json(); 

          const form = document.createElement("form");
          form.action = data.url;
          form.method = "POST";

          const inputToken = document.createElement("input");
          inputToken.type = "hidden";
          inputToken.name = "token_ws";
          inputToken.value = data.token;

          form.appendChild(inputToken);
          document.body.appendChild(form);

          form.submit();
        } catch (error) {
          console.error(error);
          alert("❌ " + error.message);
          btnPagar.disabled = false;
          btnPagar.innerHTML = `<span>Ir a Pagar con Webpay</span> <i class="ri-arrow-right-line"></i>`;
        }
      });
    });
  </script>
</Layout>
