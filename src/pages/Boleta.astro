---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <section class="section min-h-screen bg-gray-50 py-20">
    <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-8 space-y-8">
      <!-- ENCABEZADO -->
      <div class="text-center border-b pb-6">
        <img src="/images/logo.svg" alt="La Nonna" class="h-14 mx-auto mb-3" />
        <h2 class="text-3xl font-bold text-[#6E0F2C]">Boleta ElectrÃ³nica</h2>
        <p id="info-boleta" class="text-gray-600 mt-2 text-sm"></p>
      </div>

      <!-- DATOS DEL CLIENTE -->
      <div class="text-sm bg-gray-50 p-4 rounded-lg border">
        <p><strong>Cliente:</strong> Juan PÃ©rez</p>
        <p><strong>Email:</strong> juan@ejemplo.com</p>
        <p><strong>Fecha:</strong> <span id="fecha-boleta"></span></p>
      </div>

      <!-- DETALLE DE COMPRA -->
      <div class="overflow-x-auto">
        <table
          class="min-w-full border text-sm rounded-lg overflow-hidden"
          id="tabla-boleta"
        >
          <thead class="bg-[#6E0F2C] text-white">
            <tr>
              <th class="px-4 py-2 text-left">Producto</th>
              <th class="px-4 py-2 text-left">Cant.</th>
              <th class="px-4 py-2 text-left">Precio</th>
              <th class="px-4 py-2 text-left">Subtotal</th>
            </tr>
          </thead>
          <tbody id="detalle-boleta" class="text-gray-700 bg-white"></tbody>
        </table>
      </div>

      <!-- TOTAL -->
      <div class="text-right text-sm space-y-1">
        <p id="subtotal" class="text-gray-600">Subtotal: $0</p>
        <p id="iva" class="text-gray-600">IVA (19%): $0</p>
        <p id="total" class="text-xl font-bold text-[#6E0F2C] mt-2">
          Total: $0
        </p>
      </div>

      <!-- BOTONES -->
      <div class="flex justify-end gap-4 pt-4 border-t">
        <button
          id="descargar-pdf"
          class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg transition"
        >
          Descargar PDF
        </button>
        <a
          href="/"
          class="bg-[#6E0F2C] hover:bg-[#8B1E3F] text-white px-5 py-2 rounded-lg transition"
        >
          Volver al Inicio
        </a>
      </div>
    </div>
  </section>

  <script>
    // @ts-nocheck
    document.addEventListener("DOMContentLoaded", () => {
      const detalleBoleta = document.getElementById("detalle-boleta");
      const subtotalEl = document.getElementById("subtotal");
      const ivaEl = document.getElementById("iva");
      const totalEl = document.getElementById("total");
      const btnDescargar = document.getElementById("descargar-pdf");
      const infoBoleta = document.getElementById("info-boleta");
      const fechaEl = document.getElementById("fecha-boleta");

      // === Obtener datos del pedido desde localStorage ===
      const cart = JSON.parse(localStorage.getItem("ordenConfirmada") || "[]");
      const ordenID = localStorage.getItem("ordenID") || "LN-0000-00-0000";
      const totalGuardado = parseInt(localStorage.getItem("ordenTotal")) || 0;
      const deliveryCosto = parseInt(
        localStorage.getItem("deliveryCosto") || "0"
      );

      // === Mostrar encabezado ===
      const boletaID = "B-" + ordenID.replace("LN-", "LN-000");
      infoBoleta.textContent = `Orden ${ordenID} â€” Boleta ${boletaID}`;
      fechaEl.textContent = new Date().toLocaleDateString("es-CL");

      // === Si no hay productos ===
      if (!cart || cart.length === 0) {
        detalleBoleta.innerHTML = `
      <tr>
        <td colspan="4" class="text-center py-4 text-gray-500">
          No hay productos registrados en esta orden
        </td>
      </tr>`;
        subtotalEl.textContent = "Subtotal: $0";
        ivaEl.textContent = "IVA (19%): $0";
        totalEl.textContent = "Total: $0";
        return;
      }

      // === Calcular montos ===
      let subtotal = 0;

      // Agregar productos al detalle
      cart.forEach((item) => {
        const itemSubtotal = item.price * item.qty;
        subtotal += itemSubtotal;
        detalleBoleta.innerHTML += `
      <tr class="border-t hover:bg-gray-50 transition">
        <td class="px-4 py-2">${item.name}</td>
        <td class="px-4 py-2">${item.qty}</td>
        <td class="px-4 py-2">$${item.price.toLocaleString("es-CL")}</td>
        <td class="px-4 py-2">$${itemSubtotal.toLocaleString("es-CL")}</td>
      </tr>
    `;
      });

      // Agregar costo de delivery (si aplica)
      if (deliveryCosto > 0) {
        subtotal += deliveryCosto;
        detalleBoleta.innerHTML += `
      <tr class="border-t bg-gray-50">
        <td class="px-4 py-2">Delivery</td>
        <td class="px-4 py-2">1</td>
        <td class="px-4 py-2">$${deliveryCosto.toLocaleString("es-CL")}</td>
        <td class="px-4 py-2">$${deliveryCosto.toLocaleString("es-CL")}</td>
      </tr>
    `;
      }

      // Calcular IVA y total final
      const iva = Math.round(subtotal * 0.19);
      const total = subtotal + iva;

      // Mostrar resultados
      subtotalEl.textContent = "Subtotal: $" + subtotal.toLocaleString("es-CL");
      ivaEl.textContent = "IVA (19%): $" + iva.toLocaleString("es-CL");
      totalEl.textContent = "Total: $" + total.toLocaleString("es-CL");

      // === Descargar PDF (simulado) ===
      btnDescargar.addEventListener("click", () => {
        alert(`ðŸ’¾ Boleta ${boletaID} descargada con Ã©xito.`);
      });
    });
  </script>
</Layout>
