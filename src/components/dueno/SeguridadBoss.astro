---
import UsersManager from "../admin/Users.astro";

let settings: any = {};
let logs = [];

try {
  const [setRes, logRes] = await Promise.all([
    fetch("http://localhost:8000/api/admin/security/settings"),
    fetch("http://localhost:8000/api/admin/security/audit-logs"),
  ]);

  if (setRes.ok) settings = await setRes.json();
  if (logRes.ok) logs = await logRes.json();
} catch (e) {
  console.error("Error cargando seguridad dueño:", e);
}

const formatoFecha = (f: any) => new Date(f).toLocaleString("es-CL");
---

<div class="space-y-12">
  <section>
    <div class="flex items-center gap-2 mb-4">
      <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
        <i class="ri-user-settings-line text-xl"></i>
      </div>
      <div>
        <h2 class="text-xl font-bold text-primary">Usuarios y Roles</h2>
        <p class="text-sm text-gray-500">
          Gestiona quién tiene acceso al sistema.
        </p>
      </div>
    </div>
    <UsersManager />
  </section>

  <hr class="border-gray-200" />

  <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
    <div class="flex items-center gap-4 mb-6 border-b border-gray-100 pb-4">
      <div class="p-3 bg-purple-50 rounded-lg text-purple-600">
        <i class="ri-shield-keyhole-fill text-2xl"></i>
      </div>
      <div>
        <h2 class="text-xl font-bold text-gray-800">
          Políticas de Seguridad Global
        </h2>
        <p class="text-sm text-gray-500">
          Define las reglas de acceso para todos los usuarios.
        </p>
      </div>
    </div>

    <div class="space-y-6" id="security-toggles">
      <div
        class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-100"
      >
        <div class="flex gap-3">
          <i class="ri-text-spacing text-gray-400 mt-1"></i>
          <div>
            <p class="font-semibold text-gray-700 text-sm">
              Contraseñas Robustas
            </p>
            <p class="text-xs text-gray-500">
              Exigir mínimo 8 caracteres en el registro.
            </p>
          </div>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input
            type="checkbox"
            id="toggle-min-char"
            class="sr-only peer"
            checked={settings.requerirMinimoCaracteres}
          />
          <div
            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"
          >
          </div>
        </label>
      </div>

      <div
        class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-100"
      >
        <div class="flex gap-3">
          <i class="ri-time-line text-gray-400 mt-1"></i>
          <div>
            <p class="font-semibold text-gray-700 text-sm">
              Rotación de Claves
            </p>
            <p class="text-xs text-gray-500">
              Obligar a cambiar contraseña cada 90 días.
            </p>
          </div>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input
            type="checkbox"
            id="toggle-expire"
            class="sr-only peer"
            checked={settings.expiracionPassword}
          />
          <div
            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"
          >
          </div>
        </label>
      </div>

      <div
        class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-100"
      >
        <div class="flex gap-3">
          <i class="ri-smartphone-line text-gray-400 mt-1"></i>
          <div>
            <p class="font-semibold text-gray-700 text-sm">
              Autenticación en 2 Pasos (2FA)
            </p>
            <p class="text-xs text-gray-500">
              Mayor seguridad para cuentas administrativas.
            </p>
          </div>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input
            type="checkbox"
            id="toggle-2fa"
            class="sr-only peer"
            checked={settings.requerir2FA}
          />
          <div
            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"
          >
          </div>
        </label>
      </div>
    </div>
  </section>

  <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-xl font-bold text-gray-800">Auditoría de Sistema</h2>
        <p class="text-sm text-gray-500">
          Registro inmutable de actividades recientes.
        </p>
      </div>
    </div>

    <div class="overflow-hidden rounded-lg border border-gray-100">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 text-gray-700">
          <tr>
            <th class="px-6 py-3 text-left font-semibold">Usuario</th>
            <th class="px-6 py-3 text-left font-semibold">Acción</th>
            <th class="px-6 py-3 text-left font-semibold">Fecha / Hora</th>
            <th class="px-6 py-3 text-left font-semibold">IP</th>
            <th class="px-6 py-3 text-center font-semibold">Estado</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {
            logs.length === 0 ? (
              <tr>
                <td colspan="5" class="text-center py-8 text-gray-400">
                  El registro de auditoría está vacío.
                </td>
              </tr>
            ) : (
              logs.map((log: any) => (
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4 font-medium text-gray-900">
                    {log.usuario}
                  </td>
                  <td class="px-6 py-4 text-gray-600">{log.accion}</td>
                  <td class="px-6 py-4 text-gray-500 text-xs font-mono">
                    {formatoFecha(log.fecha)}
                  </td>
                  <td class="px-6 py-4 text-gray-400 text-xs font-mono">
                    {log.ip}
                  </td>
                  <td class="px-6 py-4 text-center">
                    <span
                      class={`px-2 py-1 rounded-full text-xs font-bold ${log.estado === "Exito" ? "bg-green-100 text-green-700" : "bg-red-100 text-red-700"}`}
                    >
                      {log.estado}
                    </span>
                  </td>
                </tr>
              ))
            )
          }
        </tbody>
      </table>
    </div>
  </section>
</div>

<script>
  // @ts-nocheck
  document.addEventListener("DOMContentLoaded", () => {
    const t1 = document.getElementById("toggle-min-char");
    const t2 = document.getElementById("toggle-expire");
    const t3 = document.getElementById("toggle-2fa");

    const guardarConfig = async () => {
      const data = {
        requerirMinimoCaracteres: t1.checked,
        expiracionPassword: t2.checked,
        requerir2FA: t3.checked,
      };

      try {
        await fetch("http://localhost:8000/api/admin/security/settings", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        console.log("Configuración actualizada por el Dueño");
      } catch (e) {
        console.error(e);
        alert("Error de conexión al guardar configuración.");
      }
    };

    [t1, t2, t3].forEach((t) => t?.addEventListener("change", guardarConfig));
  });
</script>
