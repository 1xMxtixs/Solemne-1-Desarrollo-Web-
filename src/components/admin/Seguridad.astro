---
let settings: any = {}; 
let logs = [];

try {
  const [setRes, logRes] = await Promise.all([
    fetch("http://localhost:8000/api/admin/security/settings"),
    fetch("http://localhost:8000/api/admin/security/audit-logs"),
  ]);
  if (setRes.ok) settings = await setRes.json();
  if (logRes.ok) logs = await logRes.json();
} catch (e) {}

const formatoFecha = (f: any) => new Date(f).toLocaleString("es-CL");
---

<div class="space-y-8">
  <div
    class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 space-y-6"
  >
    <h2 class="text-xl font-bold text-primary flex items-center gap-2">
      <i class="ri-shield-keyhole-line"></i> Configuración de Seguridad
    </h2>
    <div class="space-y-4" id="security-toggles">
      <div class="flex items-center justify-between">
        <span class="text-secondary"
          >Requerir contraseña con mínimo 8 caracteres</span
        >
        <input
          type="checkbox"
          class="toggle accent-accent"
          id="toggle-min-char"
          checked={settings.requerirMinimoCaracteres}
        />
      </div>
      <div class="flex items-center justify-between">
        <span class="text-secondary"
          >Expiración de contraseñas cada 90 días</span
        >
        <input
          type="checkbox"
          class="toggle accent-accent"
          id="toggle-expire"
          checked={settings.expiracionPassword}
        />
      </div>
      <div class="flex items-center justify-between">
        <span class="text-secondary"
          >Requerir 2FA (Autenticación en dos pasos)</span
        >
        <input
          type="checkbox"
          class="toggle accent-accent"
          id="toggle-2fa"
          checked={settings.requerir2FA}
        />
      </div>
    </div>
  </div>

  <div
    class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 space-y-6"
  >
    <h2 class="text-xl font-bold text-primary">Historial de Auditoría</h2>
    <div class="overflow-x-auto">
      <table
        class="min-w-full text-sm rounded-lg overflow-hidden shadow border border-gray-100"
      >
        <thead class="bg-primary text-white">
          <tr>
            <th class="px-4 py-3 text-left">Usuario</th>
            <th class="px-4 py-3 text-left">Acción</th>
            <th class="px-4 py-3 text-left">Fecha</th>
            <th class="px-4 py-3 text-left">IP</th>
            <th class="px-4 py-3 text-left">Estado</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {
            logs.length === 0 ? (
              <tr>
                <td colspan="5" class="text-center py-4 text-gray-500">
                  Sin registros recientes.
                </td>
              </tr>
            ) : (
              logs.map((log: any) => (
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 font-medium">{log.usuario}</td>
                  <td class="px-4 py-3">{log.accion}</td>
                  <td class="px-4 py-3 text-gray-500">
                    {formatoFecha(log.fecha)}
                  </td>
                  <td class="px-4 py-3 font-mono text-xs">{log.ip}</td>
                  <td
                    class={`px-4 py-3 font-semibold ${log.estado === "Exito" ? "text-green-600" : "text-red-600"}`}
                  >
                    {log.estado}
                  </td>
                </tr>
              ))
            )
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  document.addEventListener("DOMContentLoaded", () => {
    const t1 = document.getElementById("toggle-min-char");
    const t2 = document.getElementById("toggle-expire");
    const t3 = document.getElementById("toggle-2fa");

    const guardarConfig = async () => {
      const data = {
        requerirMinimoCaracteres: t1.checked,
        expiracionPassword: t2.checked,
        requerir2FA: t3.checked,
      };

      try {
        await fetch("http://localhost:8000/api/admin/security/settings", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        console.log("Configuración guardada");
      } catch (e) {
        console.error("Error guardando config", e);
        alert("Error de conexión");
      }
    };

    [t1, t2, t3].forEach((t) => t?.addEventListener("change", guardarConfig));
  });
</script>
